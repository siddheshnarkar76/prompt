name: FastAPI Backend CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  syntax-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Python syntax validation
      run: |
        cd backend
        find . -name "*.py" -exec python -m py_compile {} \;
        echo "✅ All Python files have valid syntax"

    - name: Check project structure
      run: |
        cd backend
        test -f app/main.py && echo "✅ Main app file exists"
        test -f requirements.txt && echo "✅ Requirements file exists"
        test -d tests && echo "✅ Tests directory exists"
        echo "✅ Project structure is valid"

    - name: Validate requirements files
      run: |
        cd backend
        python -c "
        import re
        files = ['requirements.txt', 'requirements-minimal.txt']
        for f in files:
            try:
                with open(f) as file:
                    for line_num, line in enumerate(file, 1):
                        line = line.strip()
                        if line and not line.startswith('#'):
                            if not re.match(r'^[a-zA-Z0-9_\-\[\]]+([><=!]+[0-9\.]+)?$', line.split()[0]):
                                print(f'⚠️ Potential issue in {f} line {line_num}: {line}')
                print(f'✅ {f} format is valid')
            except FileNotFoundError:
                print(f'⚠️ {f} not found')
        "
